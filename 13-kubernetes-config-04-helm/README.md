# Домашнее задание к занятию "13.4 инструменты для упрощения написания конфигурационных файлов. Helm и Jsonnet"

## Модуль 13. Конфигурация Kubernetes

### Студент: Иван Жиляев

>В работе часто приходится применять системы автоматической генерации конфигураций. Для изучения нюансов использования разных инструментов нужно попробовать упаковать приложение каждым из них.

## Задание 1: подготовить helm чарт для приложения
>Необходимо упаковать приложение в чарт для деплоя в разные окружения. Требования:
>* каждый компонент приложения деплоится отдельным deployment’ом/statefulset’ом;
>* в переменных чарта измените образ приложения для изменения версии.

Согласно требованиям задания мне нужно будет использовать прод-образы, которые я подготовил с учётом работы сервисов в разных подах (в первом ДЗ модуля я описывал какие проблемы были при использовании оригинальных исходников).

По сути шаблоны чарта должны компилироваться в стуктуру манифестов деплоя прод-окружения из [ДЗ 13.1 задание 2](https://github.com/nimlock/netology-devkub/tree/main/13-kubernetes-config-01-objects#%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-2-%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%B8%D1%82%D1%8C-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3-%D0%B4%D0%BB%D1%8F-production-%D0%BE%D0%BA%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F) - требования к деплою такие же. Для наглядности и читаемости структуры я уберу шаблоны сущностей k8s, которые не потребуются для деплоя, и добавлю шаблоны того, что потребуется.

_Примечание_: я не буду делать шаблоны для неймспейсов, так как сомневаюсь что это входит в стандартную практику работы с Helm.

Подготовленный чарт расположен в папке [helm-app-chart](helm-app-chart). Он без ошибок проходит линтер `helm lint .` и хорошо выглядит после тестовой компиляции `helm template .`.

## Задание 2: запустить 2 версии в разных неймспейсах
>Подготовив чарт, необходимо его проверить. Попробуйте запустить несколько копий приложения:
>* одну версию в namespace=app1;
>* вторую версию в том же неймспейсе;
>* третью версию в namespace=app2.

Запуск чарта в нескольких экземплярах требует переопределения для каждого из них таких параметров как переменные окружения и обслуживаемый домен для ингресс-контроллера. Вынесем эти параметры в отдельные файлы переменных.  
Произведём деплой нескольких релизов командами:

```
helm upgrade first-release ./helm-app-chart/ --install --namespace app1 --values ./helm-app-chart/values-release1.yaml
helm upgrade second-release ./helm-app-chart/ --install --namespace app1 --values ./helm-app-chart/values-release2.yaml
helm upgrade third-release ./helm-app-chart/ --install --namespace app2 --values ./helm-app-chart/values-release3.yaml
```

Проверим состояние чартов:

```
root@master1:/home/vagrant/13.4# helm list --all-namespaces -d 
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                           APP VERSION
nfs-server      default         1               2021-08-09 06:38:29.839422452 +0000 UTC deployed        nfs-server-provisioner-1.1.3    2.3.0      
first-release   app1            1               2021-08-11 20:16:08.596356558 +0000 UTC deployed        helm-app-chart-0.1.0            1.16.0     
second-release  app1            1               2021-08-11 20:17:02.368119003 +0000 UTC deployed        helm-app-chart-0.1.0            1.16.0     
third-release   app2            1               2021-08-11 20:17:05.245302744 +0000 UTC deployed        helm-app-chart-0.1.0            1.16.0 
```

## Задание 3 (*): повторить упаковку на jsonnet
>Для изучения другого инструмента стоит попробовать повторить опыт упаковки из задания 1, только теперь с помощью инструмента jsonnet.
